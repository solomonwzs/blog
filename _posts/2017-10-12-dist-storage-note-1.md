---
title: Distributed storage system note (1)
date: 2017-10-12
tags:
- distribute
- storage
category:
- note
---

分布式存储系统笔记（一）

<!-- more -->

## 分布式存储分类

### 分布式文件系统

- 存储图片、视频等非结构化数据，一般称为 Blob 数据
- 分为三种类型数据：Blob 对象，定长块，大文件
- 系统内部按照数据块（chunk）组织数据

### 分布式键值系统

- 存储半结构化数据
- 值提供主键 CRUD（Create/Read/Update/Delete）功能

### 分布式表格系统

- 支持主键 CRUD 功能及范围查找功能

### 分布式数据库

## 单机存储引擎

### 哈希存储引擎

- Bitcask，仅支持追加操作，文件达到大小限制事产生新文件，捞文件只读不写
- 记录一条条写入，内存中使用哈希表定位 value 位置
- 写入数据时先白记录追加到数据文件末尾，再更新内存表
- 定期合并，扫描老数据文件，回收垃圾数据生成新的数据文件
- 快速恢复，只读入索引文件

### B 树存储引擎

- 非叶节点存储索引，叶节点存储数据
- 修改先提交日志，再修改内存中的 B 树
- 修改页面超过一定比率，后台将页面持久化
- LRU 算法，淘汰长时间没有读写过的块
- LIRS 算法，通过链表分级，防止大量页面被替换

### LSM 树存储引擎

- 数据修改增量保存于引擎，达到大小限制后批量写入磁盘
- 内存中：Memtable，分为可变与不可变
- 磁盘中：Current，Manifest，Commit log，SSTable
- 写入时，先修改日志，再修改 Memtable
- Compaction: Memtable -> 冻结 -> SSTable
- SSTable 中的记录按照主键排序，Manifest 记录元数据
- 读取顺序：Memtable -> 不可变 Memtable -> SSTable
- 数据合并：Memtable -> SSTable，SSTable 归并


## 并发控制

- 解决死锁：事务超时回滚，检测死锁循环
- 写时复制
- 多版本并发控制，比较版本号

## 数据压缩

### 哈夫曼编码

### LZ 系列压缩算法

- 动态创建字典并保存压缩信息
- 哈希字典值保存固定长度子串

### 列式存储

- 将经常访问的数据列放在一起
- 同一列的数据重复度高，容易压缩


## 分布式系统基本概念

### 异常

- 服务器宕机，网络异常，磁盘故障
- 分布式系统三态：成功，失败，超时（未知）
- 幂等操作重试

### 一致性

- 保证多个副本之间的一致

### 性能分析

### 数据分布

- 数据分布到多个节点，并在节点间实现负载均衡
- 哈希分布，如 aws dynamo 系统
- 顺序分布，主键整体有序，如 google bigtable
- 服务器上下线导致哈希映射被打乱
    + 元数据服务器
    + 一致性哈希，虚拟节点
- 总控节点负责整体调度，工作节点通过心跳包发送负载信息

### 复制

- 强同步复制协议，异步复制协议
- 数据先写入主副本，由主副本复制到其他副本
- paxos 协议选举新的主副本
- 通过操作日志实现复制，定期生成检查点日志
- 多存储节点复制协议，不分主副，NWR 协议，W + R > N
- CAP 理论，一致性，可用性，分区可容忍性

### 容错

- 心跳检测；服务租约，通过申请租约确保服务器是否提供服务
- 单层结构，对每个数据分片维护多个副本
- 两层结构，分存储层和服务层，存储层维护多个副本，服务层只维护一个副本，当一个服务节点出故障，另一节点会从存储层复制故障服务节点的数据分片，替代故障节点

### 可扩展性

- 总控节点，通过增加层级减轻负载
- 增加副本提升读能力，拆分数据提升写性能
- 同构系统，每个节点存储相同数据，建立恢复速度慢
- 异构系统，每个节点存储不同数据分片，任意不同的健康节点可以恢复故障节点的数据分片

### 分布式协议

- 2PC，两段提交
    + 请求阶段，参与者表决是否同意事务
    + 提交阶段，当所有参与者同意事务，提交事务
    + 事务参与者故障，事务超时；协调者故障，参与者一直等待；阻塞协议
- paxos 协议，选举主节点
    + 正常情况下，与 2PC 基本相同
